# Attack a vulnerable program using strcpy() and large enough buffer with C from command line
The victim program is same as the one in the [Python version attack](../). Instead of using the Python code for the attack, we write a C program for the attack.

## Attack Steps
### Step 1. Assemble and link calc-shell.asm to get the shellcode
1. Use [arwin](https://github.com/xinwenfu/arwin) to get the address of *WinExec*
   - ``` arwin kernel32.dll WinExec ```
3. Change calc-shell.asm in terms of the address of WinExec
4. Assemble and link calc-shell.asm
5. Use *Immunity Debugger*'s binary copy to get the shellcode

### Step 2. Craft the malicious string
1. Compile victim3.c
2. Load victim3.exe into IDA Freeware and find the address of the main function and its stack layout so as to derive the length of the malicious string
3. Use Immunity Debugger to find the address of the local buffer and thus the address of the shellcode
4. Craft the malicious string with the shellcode and its address

### Step 3. Attack
1. Run xploitViaCmdline.exe at command promput (cmd.exe), which stores the malcioius string in an environment variable called *fxw*
2. victim3 %fxw%

## Notes

### Disassembly of main function
```
.text:004015C0 ; Attributes: bp-based frame fuzzy-sp
.text:004015C0
.text:004015C0 ; int __cdecl main(int argc, const char **argv, const char **envp)
.text:004015C0                 public _main
.text:004015C0 _main           proc near               ; CODE XREF: ___tmainCRTStartup+236â†‘p
.text:004015C0
.text:004015C0 var_40          = byte ptr -40h
.text:004015C0 argc            = dword ptr  8
.text:004015C0 argv            = dword ptr  0Ch
.text:004015C0 envp            = dword ptr  10h
.text:004015C0
.text:004015C0                 push    ebp
.text:004015C1                 mov     ebp, esp
.text:004015C3                 and     esp, 0FFFFFFF0h
.text:004015C6                 sub     esp, 50h
.text:004015C9                 call    ___main		; added by gcc; can be ignored
.text:004015CE                 mov     eax, [ebp+argv]
.text:004015D1                 add     eax, 4
.text:004015D4                 mov     eax, [eax]
.text:004015D6                 mov     [esp+4], eax    ; char *
.text:004015DA                 lea     eax, [esp+50h+var_40]
.text:004015DE                 mov     [esp], eax      ; char *
.text:004015E1                 call    _strcpy
.text:004015E6                 mov     eax, 0
.text:004015EB                 leave
.text:004015EC                 retn
.text:004015EC _main           endp
```

### Stack frame of main function at 004015C9
```
	    +------------------+
	    |     **envp	     | 4 bytes
	    +------------------+
	    |      **argv	     | 4 bytes
	    +------------------+
	    |       argc	     | 4 bytes
	    +------------------+
	    |  return address  | 4 bytes
	    +------------------+
	    |     old ebp	     | 4 bytes
EBP -> +------------------+
	    |		              | 4 bytes
	    +------------------+
	    |		              | 4 bytes
	    +------------------+		 ---
	    |		              |         ^
	    .           		  .         |
	    |		              |    40h=4*16 bytes
	    .                  .		   |
	    |		              |       	v
	    +------------------+	     -- <--- buf
	    |		              | 4 bytes
	    +------------------+
	    |		              | 4 bytes
	    +------------------+
	    |		              | 4 bytes
	    +------------------+
	    |		              | 4 bytes
ESP -> +------------------+
```
