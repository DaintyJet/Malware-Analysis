# Create vulnserver module for metasploit

## Update metasploit
The default installed metasploit in Kali has some issues with modules in a user folder (?). If a module is copied to the [metasploit modules folder](https://www.offensive-security.com/metasploit-unleashed/modules-and-locations/) (e.g. /usr/share/metasploit-framework/modules/), it was ok. Updating the metasploit-framework sovles the issue
```
sudo apt update; sudo apt install metasploit-framework 
```

## Create a custom module
Create a local user module in ~/.msf4/modules, for example, /home/kali/.msf4/modules/exploits/windows/vulnserver/[knock.rb](knock.rb). which the example module in this repository.

I'm not sure if the following command is needed or not and use it anyway whenever I add a module
```
sudo updatedb
```
When metasploit starts, it loads all modules too.

In the Metasploit session, if the module is changed, use the following command within metasploit to reload/refresh all modules
```
reload_all
```
## Use a new module
Once a new module is successfully created, it can be used within both metasploit and armitage.

Below is a screenshot showing armitage can find the vulnserver attack.
[img src="imgs/armitage-find-vulnserver-attack.png"]

Below is a screenshot showing armitage successfully launches the vulnserver attack and we can start a meterpreter shell to list webcams on the target Windows 10 VM. Remember attack the webcam to the Windows 10 VM: *Devices* -> *Webcams* -> Click one
[img src="imgs/armitage-find-vulnserver-meterpreter.png"]

## Ruby programming notes for metasploit modules
[register_options](https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf/Opt)
```
    register_options(
      [
        Opt::RPORT(9999),
	Opt::LPORT(11111)
      ])
```
Available options: CHOST(), CPORT(), LHOST(), LPORT(), Proxies(), RHOST(), RHOSTS(), RPORT(), SSLVersion()

## References
1. [Building A Metasploit Module](https://www.offensive-security.com/metasploit-unleashed/building-module/)
2. [Exploiting Simple Buffer Overflow (3) - Writing a simple Metasploit module](https://taishi8117.github.io/2016/07/24/bof-metasploit/), 24 Jul 2016
3. Peleus, [Converting Metasploit Module to Stand Alone](https://netsec.ws/?p=262)
4. v4L, [What Is Metasploit EXITFUNC?](https://www.hacking-tutorial.com/tips-and-trick/what-is-metasploit-exitfunc/#sthash.zpY6gQrl.Mz7vtiHY.dpbs)
5. [rapid7/metasploit-framework](https://github.com/rapid7/metasploit-framework/wiki/), Metasploit Development
6. Ivan, [Rewriting a Ruby msf exploit in Python](https://ivanitlearning.wordpress.com/2019/09/01/rewriting-a-ruby-msf-exploit-in-python/), September 1, 2019
7. [Incident Response and the ATT&CK Matrix 2020 CTF](https://samsclass.info/152/IR2020.htm), Writing a Custom Metasploit Module
8. [Ruby metasploit-framework class list](https://www.rubydoc.info/github/rapid7/metasploit-framework/)
